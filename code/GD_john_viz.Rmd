---
title: "GD_property"
author: "John Park"
date: "5/15/2020"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(tidyverse)
library(sf)
library(showtext)
```

## Set up
```{r}
# function to get assessment
get_ass <- function(pid) {
  file <- paste0("../data/raw/property/valuations/", pid, ".RDS")
  dat <- readRDS(file)[[1]]
  if(dat[1,1] != "No Data for Assessment History") {
    assessment <- dat %>% 
      dplyr::filter(`Valuation Year` == 2017) %>% 
      select(Total)
    return(assessment$Total)
  }
  else return(NA)
}

font_add_google("Ubuntu Condensed", "ubuntu")
showtext_auto()
tol12 <- PerformanceAnalytics::tol12qualitative
```


## Research

**Mark Mininberg**
By 1930, Yale property had been worth an amount equal to over ten per-cent of the city’s grand list of taxable property. The university increased its tax-exempt land by approximately 20 percent between 1930 and 1933. The decrease in the grand list which resulted cut further into the city’s already limited tax base, while Yale continued to receive free police and fire protection and use of the sewage system.

Harvard, aware of the damage excessive tax exemptions caused Cambridge, had agreed in 1928 to pay moderate taxes on its properties.

In all, thirty-five buildings would be built from 1929 to 1937 at a cost of $52 million.

The first week of June [i think 1937], Murphy met with Yale President Rowland Angell and members of the Corporation at Woodbridge Hall to try to persuade them to make some small contribution to the relief of the people. Yale’s endowment had grown fourfold since 1921, from $25.7 million to $107.6 million, and the mayor naively anticipated some kind of positive response. He had, after all, welcomed Angell to New Haven.

**McCullough**
*From Margaret Hogg and Ralph Hurlin’s The Incidence of Work Shortage in New Haven, CT, as seen in Douglas Rae, City: Urbanism and Its End (New Haven: Yale University Press, 2003), 239.*
By 1931, about 10,000 New Haveners, an unprecedented number in a city of only 162,000, were out of work; many more faced reduced hours and wages. As researcher Margaret Hogg reports, “About 3,400 families had all their earners idle, and these contained about 10,900 persons of whom 3,100 were children under fourteen years of age. In addition, about 17,850 families had some work shortage.


## Contextual points
* 1931: unemployment reaches about 10,000 (6.2%), many more face reduced hours and wages
* 1930-1933: university increases tax-exempt land by ~20 percent
* 1929-1937: 35 buildings built at cost of $52 million



## Using use_this
```{r}
use_this <- readRDS("../data/clean/use_this.RDS") %>% janitor::clean_names()
```

```{r}
years <- data.frame(year_built=1924:1940)
yale <- use_this %>% 
  as_tibble() %>% 
  select(address, owner, pid, year_built, valuation_year) %>% 
  mutate_at(vars(pid:valuation_year), as.numeric) %>% 
  mutate_at(vars(address:owner), tolower) %>% 
  filter(year_built >= 1924 & year_built <= 1940) %>% 
  arrange(year_built) %>% 
  filter(str_detect(owner, "yale")) %>% 
  mutate(assessment = map(.$pid, get_ass) %>% unlist()) %>% 
  mutate(assessment = parse_number(assessment)) %>% 
  mutate(assessment = as.numeric(assessment)) %>% 
  mutate(tax = assessment * 0.4298) %>% 
  bind_rows(years) %>% 
  mutate_at(vars(assessment:tax), replace_na, 0)

yale_annual <- yale %>% 
  group_by(year_built) %>% 
  summarise(assessment=sum(assessment)/1e6, tax=sum(tax)/1e6) %>% 
  mutate(is_gd = as.factor(year_built >= 1929 & year_built <= 1935))
```
```{r}
theme_nkjp <- function(base_size = 14, base_family = "ubuntu") {
  showtext::showtext_auto(enable = TRUE)
  loaded_fonts <- sysfonts::font_families()
  out <- ggplot2::theme_light(base_size = base_size, base_family = base_family) +
    ggplot2::theme(
      plot.caption = ggplot2::element_text(vjust = 1, size = ggplot2::rel(0.7), color = "gray30", margin = ggplot2::margin(12, 0, 0, 0)),
      axis.ticks = ggplot2::element_blank(),
      panel.grid.major = ggplot2::element_line(colour = "gray85"),
      panel.grid.minor = ggplot2::element_blank(),
      axis.text = ggplot2::element_text(color = "gray30", size = ggplot2::rel(0.8)),
      plot.title = ggplot2::element_text(face = "bold", colour = "gray10"),
      plot.subtitle = ggplot2::element_text(color = "gray30", size = ggplot2::rel(0.9)),
      panel.background = ggplot2::element_rect(fill = "gray95"),
      panel.border = ggplot2::element_blank(),
      strip.background = ggplot2::element_rect(fill = "gray105"),
      strip.text = ggplot2::element_text(color = "gray30"))
  return(out)
}
```

```{r}
plot1 <- yale_annual %>% ggplot(aes(x=year_built, y=assessment)) +
  geom_rect(aes(xmin = 1928.75, xmax = 1935.25, ymin = 0, ymax = Inf, fill = "GREEN", color="GREEN"), alpha = 0.05) +
  geom_point(size = 3, color="gray30") +
  theme_nkjp() +
  theme(legend.position = "none",
      panel.grid.major.y = element_blank(),
      plot.caption = element_text(margin = margin(2, 2, 1, 0, "lines"))) +
  labs(x = "", y = "",
      title = "Current Assessment (2018) of Yale properties built 1925-1940",
      subtitle = "The Great Depression saw a major Yale expansion") +
  scale_x_continuous(breaks = seq(1924, 1940, by = 2)) +
  scale_y_continuous(labels=scales::dollar_format(prefix="$ ", suffix=" M"))

ggsave("../viz/JP_plot1.png", width = 7, height = 4)
```


## regex
```{r}
# non-tax paying properties
relig <- c("churc", "prayer", "congreg", "baptist", "varic", "catholic", 
           "praise", "deliverance", "chapel", "saint", "pentec", "methodi",
           "parish", "st luke")
other <- c("yale", "city of", "cit of", "preparatory", "prepatory", "cornell scott")
non_tax <- c(relig, other) %>%
  paste(collapse = "|") %>% 
  substr(0, nchar(.))

# non-residential properties
non_res <- c("llc", "partners", "conference", "inc", "supreme") %>% 
  paste(collapse="|") %>% 
  substr(0, nchar(.))
```

## Dixwell
```{r}
dixwell_sf <- cwi::new_haven_sf %>% filter(name == "Dixwell")
dixwell_raw <- rawproperties[which(st_within(rawproperties$geometry, dixwell_sf) %>% 
  as.numeric()==1),] %>% 
  as_tibble() %>% 
  select(address, owner) %>% 
  left_join(full_df) %>% # go back to using full_df (contains pid)
  select(address, owner, pid) %>% 
  drop_na()

xtra_non_tax <- c("state of connecticut", 
                  "neighborhood housing services",
                  "youth continuum inc", "land trust", non_tax) %>% 
  paste(collapse="|") %>% 
  substr(0, nchar(.)-1)

dixwell_df <- dixwell_raw %>% 
  mutate(assessment = map(.$pid, get_ass) %>% unlist()) %>% 
  mutate(assessment = parse_number(assessment)) %>% 
  mutate(assessment = as.numeric(assessment)) %>% 
  mutate(tax = assessment * 0.4298) %>% 
  mutate_if(is.character, tolower) %>% 
  filter(!str_detect(owner, xtra_non_tax)) %>% 
  drop_na()

dixwell_df %>% summarize(tot = sum(tax))

dixwell_df %>% arrange(desc(assessment))
```

## Newhallville
```{r}
nhville_sf <- cwi::new_haven_sf %>% filter(name == "Newhallville")
nhville_raw <- rawproperties[which(st_within(rawproperties$geometry, nhville_sf) %>% 
  as.numeric()==1),] %>% 
  as_tibble() %>% 
  select(address, owner) %>% 
  left_join(full_df) %>% # go back to using full_df (contains pid)
  select(address, owner, pid) %>% 
  drop_na()

xtra_non_tax <- c("mutual housing association of south cent", 
                  "housing authority of new haven",
                  "youth continuum inc", "land trust", "empowerment",
                  non_tax) %>% 
  paste(collapse="|") %>% 
  substr(0, nchar(.)-1)

nhville_df <- nhville_raw %>% 
  mutate(assessment = map(.$pid, get_ass) %>% unlist()) %>% 
  mutate(assessment = parse_number(assessment)) %>% 
  mutate(assessment = as.numeric(assessment)) %>% 
  mutate(tax = assessment * 0.4298) %>% 
  mutate_if(is.character, tolower) %>% 
  filter(!str_detect(owner, xtra_non_tax)) %>% 
  drop_na()

nhville_df %>% summarize(tot = sum(tax))
nhville_df %>% arrange(desc(assessment))

nhville_df_res <- nhville_df %>% 
  filter(!str_detect(owner, non_res))

nhville_df_res %>% summarize(tot = sum(tax))
nhville_df_res %>% arrange(desc(assessment))
```

## Dixwell Ave.
```{r}
dixwellave_raw <- full_df %>% 
  filter(str_detect(address, "DIXWELL")) %>% 
  select(address, owner, pid)

dixwellave_df <- dixwellave_raw %>% 
  mutate(assessment = map(.$pid, get_ass) %>% unlist()) %>% 
  mutate(assessment = parse_number(assessment)) %>% 
  mutate(assessment = as.numeric(assessment)) %>% 
  mutate(tax = assessment * 0.4298) %>% 
  mutate_if(is.character, tolower) %>% 
  filter(!str_detect(owner, non_tax))

dixwellave_df %>% summarize(tot = sum(tax))
dixwellave_df %>% arrange(desc(assessment))

dixwellave_df_res <- dixwellave_df %>% 
  filter(!str_detect(owner, non_res))

dixwellave_df_res %>% summarize(tot = sum(tax))
dixwellave_df_res %>% arrange(desc(assessment))
```

## GD Data
```{r}
GD_raw <- readxl::read_excel("../data/clean/Great Depression Buildings.xlsx") %>% janitor::clean_names()
GD_df <- GD_raw %>% 
  select(appraisal = x2019_appraisal, assessment = x2019_assessment, exemption = current_tax_exemption, everything()) %>% 
  mutate(year_built=as.numeric(year_built)) %>% 
  filter(!is.na(year_built)) %>% 
  mutate(location = ifelse(is.na(building), address, building)) %>% 
  group_by(year_built) %>% 
  summarise(appraisal=sum(appraisal), assessment=sum(assessment), exemption=sum(exemption), num_built=n()) %>% 
  ungroup()
```

## Viz 1: a failure
```{r}
ref_1 <- dixwellave_df_res %>% summarize(tot = sum(tax)) %>% unlist()
ref_2 <- 2500000

df %>% 
  ggplot(aes(x=year, y=val)) +
  geom_vline(aes(xintercept = year), color = "white", size = 0.4) +
  geom_hline(aes(yintercept = ref_1), color = "blue", size = 0.7, linetype = "22") +
  geom_text(aes(label = "Property tax of all NHV residential\nbuildings on Dixwell Ave, 2017.", x = 1935, y = ref_1),
            hjust = 0.9, vjust = -0.75, color = "blue", size = 2.5) +
  geom_hline(aes(yintercept = ref_2), color = "red", size = 0.7, linetype = "22") +
  geom_text(aes(label = "reference 2", x = 1935, y = ref_2),
            hjust = 0.75, vjust = -2, color = "red", nudge_y = -20, nudge_x = 0, size = 2.5) +
  geom_point(color = "gray30", size = 4) +
  theme(legend.position = "none",
        plot.caption = element_text(margin = margin(2, 2, 1, 0, "lines"))) +
    labs(x = "", y = "Tax exemption $ (2017)",
       title = "Tax exemption of Yale properties built during the Great Depression",
       subtitle = "subtitle",
       caption = "Source: City of New Haven") +
  scale_x_continuous(breaks = seq(1929, 1935, by = 1)) +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6))
```



