---
title: "GD_property"
author: "John Park"
date: "5/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(tidyverse)
```

## NHV property data (all 2017 numbers)
```{r}
full_df <- readRDS("../data/raw/property/full_df.RDS")
```

## Dixwell Ave.
```{r}
dixwell_raw <- full_df %>% 
  filter(str_detect(address, "DIXWELL")) %>% 
  select(address, owner, pid)
file <- paste0("../data/raw/property/valuations/", 102283, ".RDS")

get_ass <- function(pid) {
  file <- paste0("../data/raw/property/valuations/", pid, ".RDS")
  assessment <- readRDS(file)[[1]] %>% 
    dplyr::filter(`Valuation Year` == 2017) %>% 
    select(Total)
  return(assessment$Total)
}

dixwell_df <- dixwell_raw %>% 
  mutate(assessment = map(.$pid, get_ass) %>% unlist()) %>% 
  mutate(assessment = parse_number(assessment)) %>% 
  mutate(assessment = as.numeric(assessment)) %>% 
  mutate(tax = assessment * 0.4298) %>% 
  mutate_if(is.character, tolower) %>% 
  filter(!str_detect(owner, non_tax))

dixwell_df %>% summarize(tot = sum(tax))

relig <- c("churc", "prayer", "congreg", "baptist", "varic", "catholic", "praise", "deliverance")
other <- c("yale", "city of", "cit of", "preparatory", "cornell scott", "")
non_tax <- c(relig, other) %>%
  paste(collapse = "|") %>% 
  substr(0, nchar(.)-1)

dixwell_df %>% arrange(desc(assessment))
```

## Newhallville
```{r}
nhville_df<- full_df %>% 
  filter(str_detect(address, "DIXWELL")) %>% 
  select(address, owner, pid)
file <- paste0("../data/raw/property/valuations/", 102283, ".RDS")

get_geocode <- function(pid) {
  file <- paste0("../data/raw/geocodes", pid, ".RDS")
  geocode <- readRDS(file)[[1]] %>% 
    dplyr::filter(`Valuation Year` == 2017) %>% 
    select(Total)
  return(assessment$Total)
}

readRDS("../data/raw/geocodes/1 BROADWAY.RDS")

dixwell_df <- dixwell_raw %>% 
  mutate(assessment = map(.$pid, get_ass) %>% unlist()) %>% 
  mutate(assessment = parse_number(assessment)) %>% 
  mutate(assessment = as.numeric(assessment)) %>% 
  mutate(tax = assessment * 0.4298) %>% 
  mutate_if(is.character, tolower) %>% 
  filter(!str_detect(owner, non_tax))

dixwell_df %>% summarize(tot = sum(tax))

relig <- c("churc", "prayer", "congreg", "baptist", "varic", "catholic", "praise", "deliverance")
other <- c("yale", "city of", "cit of", "preparatory", "cornell scott", "")
non_tax <- c(relig, other) %>%
  paste(collapse = "|") %>% 
  substr(0, nchar(.)-1)

dixwell_df %>% arrange(desc(assessment))
```


## GD Data
```{r}
raw <- readxl::read_excel("../data/clean/Great Depression Buildings.xlsx") %>% janitor::clean_names()
df <- raw %>% select(exemption = current_tax_exemption, year=year_built) %>% 
  mutate(year=as.numeric(year)) %>% 
  drop_na() %>% 
  group_by(year) %>% 
  summarise(val=sum(exemption)) %>% 
  mutate(val=cumsum(val))
```

```{r}
ref_1 <- dixwell_df %>% summarize(tot = sum(tax)) %>% unlist()

df %>% 
  ggplot(aes(x=year, y=val)) +
  geom_rect(aes(xmin=lag(year), xmax=year, ymin=0, ymax=Inf, alpha=0.7)) +
  geom_vline(aes(xintercept = year), color = "white", size = 0.4) +
  geom_hline(aes(yintercept = ref_1), 
             color = "gray50", size = 0.7, linetype = "22") +
  geom_text(aes(label = "Property tax of all buildings\non Dixwell Ave in NHV, 2017.", x = 1935, y = ref_1),
            hjust = 0.75, vjust = 1.5, color = "gray20", size = 2.5) +
  geom_hline(aes(yintercept = 25e6), color = "gray50", size = 0.7, linetype = "22") +
  geom_text(aes(label = "reference 2", x = 1935, y = 25e6),
            hjust = 0.75, vjust = 2, color = "gray20", nudge_y = -20, nudge_x = 0, size = 2.5) +
  geom_point(color = "gray30", size = 4) +
  theme(legend.position = "none",
        plot.caption = element_text(margin = margin(2, 2, 1, 0, "lines"))) +
    labs(x = NULL, y = "Tax Exemption (cumulative)",
       title = "Tax exemption of Yale properties acquired during the Great Depression",
       subtitle = "Surpass reference 2",
       caption = "Source: City of New Haven") +
  scale_x_continuous(breaks = seq(1929, 1935, by = 1)) +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 1e-6))
```

